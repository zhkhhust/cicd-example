name: "localrun"

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'main.py'
      - 'pyproject.toml'
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    name: ğŸš€ Deploy Flask App
    runs-on: self-hosted
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: âš™ï¸ Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5

      
      - name: ğŸ“¦ Install dependencies
        run: |
          uv sync
          
      - name: ğŸ§ª Run tests before deploy
        run: |
          uv run pytest tests/test_main.py -v
          
      - name: ğŸ›‘ Stop and remove old Docker container
        continue-on-error: true
        run: |
          echo "Checking for existing Flask container..."
          
          # Stop and remove container if exists
          if docker ps -a | grep -q flask-app; then
            echo "Stopping and removing existing Flask container..."
            docker stop flask-app 2>/dev/null || true
            docker rm flask-app 2>/dev/null || true
            echo "âœ… Removed existing container"
          else
            echo "âš ï¸ No existing container found"
          fi
          
          # Also remove old image if exists
          if docker images | grep -q "flask-app"; then
            echo "Removing old Docker image..."
            docker rmi flask-app:latest 2>/dev/null || true
          fi
          
          echo "âœ… Cleanup completed"
          
      - name: ğŸ³ Build Docker image
        run: |
          echo "Building Docker image for Flask app..."
          docker build -t flask-app:latest .
          echo "âœ… Docker image built successfully"
          
      - name: ğŸš€ Start Docker container
        run: |
          echo "Starting Flask application in Docker container..."
          
          # Run the container in detached mode with restart policy
          docker run -d \
            --name flask-app \
            --restart unless-stopped \
            -p 5000:5000 \
            flask-app:latest
          
          echo "âœ… Flask container started"
          echo "Container will continue running after workflow completes"
          
      - name: â³ Wait for server to start
        run: |
          echo "Waiting 5 seconds for server to initialize..."
          sleep 5
          
      - name: ğŸ“‹ Show Docker Container Logs
        run: |
          echo "=== Flask Docker Container Logs ==="
          docker logs flask-app
          echo "===================================="
          
      - name: ğŸ” Verify Docker Container
        run: |
          echo "Checking Docker container status..."
          
          # Check if container is running
          if docker ps | grep -q flask-app; then
            echo "âœ… Flask container is running!"
            docker ps | grep flask-app
          else
            echo "âŒ Flask container is not running!"
            echo "Checking all containers..."
            docker ps -a | grep flask-app || echo "Container not found"
            exit 1
          fi
          
          echo ""
          echo "Container details:"
          docker inspect flask-app --format='{{.State.Status}}: {{.State.Running}}'
          
          echo ""
          echo "Container logs (last 20 lines):"
          docker logs --tail 20 flask-app
          
      - name: ğŸŒ Health Check
        run: |
          echo "Performing health check..."
          curl -f http://localhost:5000/ || exit 1
          echo "âœ… Server is running!"
          
      - name: ğŸ“ Docker Container Info
        if: success()
        run: |
          echo "==================================="
          echo "Flask Docker Container Information"
          echo "==================================="
          echo "Status: Running âœ…"
          echo "URL: http://localhost:5000"
          echo ""
          echo "Container Management Commands:"
          echo "  docker ps              - List running containers"
          echo "  docker logs flask-app  - View container logs"
          echo "  docker stop flask-app  - Stop the container"
          echo "  docker start flask-app - Start the container"
          echo "  docker restart flask-app - Restart the container"
          echo ""
          echo "Available Endpoints:"
          echo "  GET  /           - Home page"
          echo "  GET  /items      - Get all items"
          echo "  POST /items      - Create item"
          echo "  GET  /items/<id> - Get item by ID"
          echo "  PUT  /items/<id> - Update item"
          echo "  DELETE /items/<id> - Delete item"
          echo "==================================="
          
      - name: ğŸ§ª Test API Endpoints
        if: success()
        run: |
          echo "Testing API endpoints..."
          
          # Test home endpoint
          echo "Testing GET /..."
          curl -s http://localhost:5000/ | jq '.'
          
          # Test creating an item
          echo "Testing POST /items..."
          curl -s -X POST http://localhost:5000/items \
            -H "Content-Type: application/json" \
            -d '{"name": "GitHub Actions Test", "description": "Created by CI/CD"}' | jq '.'
          
          # Test getting all items
          echo "Testing GET /items..."
          curl -s http://localhost:5000/items | jq '.'
          
          echo "âœ… All API endpoints tested successfully!"
          
      - name: âœ… Deployment Summary
        if: success()
        run: |
          echo "==================================="
          echo "ğŸ‰ Deployment Successful!"
          echo "==================================="
          echo "Flask application deployed and tested"
          echo "All tests passed âœ…"
          echo "Server is production ready ğŸš€"
          echo "==================================="