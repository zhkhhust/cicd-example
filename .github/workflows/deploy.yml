name: "localrun"

on:
  workflow_dispatch:  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë
  push:
    branches:
      - main
    paths:
      - 'main.py'
      - 'pyproject.toml'
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    name: üöÄ Deploy Flask App
    runs-on: self-hosted
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: ‚öôÔ∏è Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          
      - name: üêç Set up Python
        uses: actions/setup-python@v5

      
      - name: üì¶ Install dependencies
        run: |
          uv sync
          
      - name: üß™ Run tests before deploy
        run: |
          uv run pytest tests/test_main.py -v
          
      - name: üõë Stop existing Flask Server (if running)
        shell: pwsh
        run: |
          Write-Host "Checking for existing Flask server..."
          if (Test-Path server.pid) {
            $oldPid = Get-Content server.pid
            $process = Get-Process -Id $oldPid -ErrorAction SilentlyContinue
            if ($process) {
              Write-Host "Killing existing server with PID: $oldPid"
              Stop-Process -Id $oldPid -Force
              Start-Sleep -Seconds 2
            }
            Remove-Item server.pid -Force
          }
          # Kill any process using port 5000
          $port = 5000
          $connections = Get-NetTCPConnection -LocalPort $port -ErrorAction SilentlyContinue
          if ($connections) {
            foreach ($conn in $connections) {
              $process = Get-Process -Id $conn.OwningProcess -ErrorAction SilentlyContinue
              if ($process) {
                Write-Host "Killing process $($process.Id) using port $port"
                Stop-Process -Id $conn.OwningProcess -Force
              }
            }
          }
          
      - name: üöÄ Start Flask Server
        shell: pwsh
        run: |
          Write-Host "Starting Flask server in background..."
          # Start the process in background using PowerShell
          $processInfo = Start-Process -FilePath "uv" -ArgumentList "run", "python", "main.py" -WindowStyle Hidden -RedirectStandardOutput "flask_server.log" -RedirectStandardError "flask_server_error.log" -PassThru
          $pid = $processInfo.Id
          Write-Host "Server PID: $pid"
          $pid | Out-File -FilePath "server.pid" -Encoding utf8
          Write-Host "Server started in background, will continue running after workflow completes"
          Write-Host "Step completed successfully"
          
      - name: ‚è≥ Wait for server to start
        run: |
          echo "Waiting 5 seconds for server to initialize..."
          sleep 5
          
      - name: üìã Show Server Logs
        run: |
          echo "=== Flask Server Logs ==="
          cat flask_server.log
          echo "========================="
          
      - name: üîç Verify Server Process
        shell: pwsh
        run: |
          Write-Host "Checking if server process is still running..."
          if (Test-Path server.pid) {
            $pid = Get-Content server.pid
            $process = Get-Process -Id $pid -ErrorAction SilentlyContinue
            if ($process) {
              Write-Host "‚úÖ Server process (PID: $pid) is running!"
              Write-Host "Process name: $($process.ProcessName)"
              Write-Host "Start time: $($process.StartTime)"
            } else {
              Write-Host "‚ùå Server process (PID: $pid) is not running!"
              Write-Host "Checking for any processes using port 5000..."
              Get-NetTCPConnection -LocalPort 5000 -ErrorAction SilentlyContinue | Format-Table
            }
          } else {
            Write-Host "‚ùå server.pid file not found!"
          }
          
      - name: üåê Health Check
        run: |
          echo "Performing health check..."
          curl -f http://localhost:5000/ || exit 1
          echo "‚úÖ Server is running!"
          
      - name: üìù Server Info
        if: success()
        run: |
          echo "==================================="
          echo "Flask Server Information"
          echo "==================================="
          echo "Status: Running ‚úÖ"
          echo "URL: http://localhost:5000"
          echo ""
          echo "Available Endpoints:"
          echo "  GET  /           - Home page"
          echo "  GET  /items      - Get all items"
          echo "  POST /items      - Create item"
          echo "  GET  /items/<id> - Get item by ID"
          echo "  PUT  /items/<id> - Update item"
          echo "  DELETE /items/<id> - Delete item"
          echo "==================================="
          
      - name: üß™ Test API Endpoints
        if: success()
        run: |
          echo "Testing API endpoints..."
          
          # Test home endpoint
          echo "Testing GET /..."
          curl -s http://localhost:5000/ | jq '.'
          
          # Test creating an item
          echo "Testing POST /items..."
          curl -s -X POST http://localhost:5000/items \
            -H "Content-Type: application/json" \
            -d '{"name": "GitHub Actions Test", "description": "Created by CI/CD"}' | jq '.'
          
          # Test getting all items
          echo "Testing GET /items..."
          curl -s http://localhost:5000/items | jq '.'
          
          echo "‚úÖ All API endpoints tested successfully!"
          
      - name: ‚úÖ Deployment Summary
        if: success()
        run: |
          echo "==================================="
          echo "üéâ Deployment Successful!"
          echo "==================================="
          echo "Flask application deployed and tested"
          echo "All tests passed ‚úÖ"
          echo "Server is production ready üöÄ"
          echo "==================================="