name: "localrun"

on:
  workflow_dispatch:  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë
  push:
    branches:
      - main
    paths:
      - 'main.py'
      - 'pyproject.toml'
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    name: üöÄ Deploy Flask App
    runs-on: self-hosted
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: ‚öôÔ∏è Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          
      - name: üêç Set up Python
        uses: actions/setup-python@v5

      
      - name: üì¶ Install dependencies
        run: |
          uv sync
          
      - name: üß™ Run tests before deploy
        run: |
          uv run pytest tests/test_main.py -v
          
      - name: üõë Stop Flask Server (if running)
        continue-on-error: true
        run: |
          echo "Checking for existing Flask server..."
          
          # Kill screen session if exists
          if screen -list | grep -q "flask-app"; then
            echo "Stopping existing Flask screen session..."
            screen -S flask-app -X quit 2>/dev/null || true
            echo "‚úÖ Stopped Flask screen session"
          fi
          
          # Kill by PID file if exists
          if [ -f server.pid ]; then
            OLD_PID=$(cat server.pid)
            if ps -p $OLD_PID > /dev/null 2>&1; then
              echo "Killing process with PID: $OLD_PID"
              kill $OLD_PID 2>/dev/null || true
              sleep 1
              kill -9 $OLD_PID 2>/dev/null || true
            fi
            rm -f server.pid
          fi
          
          # Kill any process using port 5000
          if command -v lsof >/dev/null 2>&1; then
            lsof -ti:5000 | xargs kill -9 2>/dev/null || true
          elif command -v fuser >/dev/null 2>&1; then
            fuser -k 5000/tcp 2>/dev/null || true
          fi
          
          echo "‚úÖ Cleanup completed"
          
      - name: üöÄ Start Flask Server in screen session
        run: |
          echo "Starting Flask server in screen session..."
          
          # Start the server in a detached screen session
          screen -dmS flask-app bash -c "uv run python main.py > flask_server.log 2>&1"
          
          # Wait a moment for the process to start
          sleep 2
          
          # Get the PID of the screen session
          SCREEN_PID=$(screen -list | grep flask-app | awk -F '.' '{print $1}' | head -1)
          
          if [ -n "$SCREEN_PID" ]; then
            echo "‚úÖ Flask server started in screen session"
            echo "Screen session PID: $SCREEN_PID"
            echo $SCREEN_PID > server.pid
          else
            echo "‚ö†Ô∏è Warning: Could not get screen PID, but server may still be starting"
          fi
          
          echo "Server will continue running after workflow completes"
          
      - name: ‚è≥ Wait for server to start
        run: |
          echo "Waiting 5 seconds for server to initialize..."
          sleep 5
          
      - name: üìã Show Server Logs
        run: |
          echo "=== Flask Server Logs ==="
          if [ -f flask_server.log ]; then
            cat flask_server.log
          else
            echo "Log file not found yet"
          fi
          echo "========================="
          
      - name: üîç Verify Server Process
        run: |
          echo "Checking Flask screen session status..."
          
          # Check if screen session exists
          if screen -list | grep -q "flask-app"; then
            echo "‚úÖ Flask screen session is running!"
            screen -list | grep flask-app
          else
            echo "‚ùå Flask screen session not found!"
            echo "Checking for any Python process on port 5000..."
            
            if command -v lsof >/dev/null 2>&1; then
              lsof -i :5000 || echo "No process found on port 5000"
            elif command -v netstat >/dev/null 2>&1; then
              netstat -tlnp 2>/dev/null | grep 5000 || echo "No process found on port 5000"
            fi
            
            # If no process found, fail the step
            if ! lsof -i :5000 >/dev/null 2>&1 && ! netstat -tlnp 2>/dev/null | grep -q 5000; then
              echo "‚ùå No Flask server process found!"
              exit 1
            fi
          fi
          
          echo ""
          echo "Screen sessions:"
          screen -list || echo "No screen sessions found"
          
      - name: üåê Health Check
        run: |
          echo "Performing health check..."
          curl -f http://localhost:5000/ || exit 1
          echo "‚úÖ Server is running!"
          
      - name: üìù Server Info
        if: success()
        run: |
          echo "==================================="
          echo "Flask Server Information"
          echo "==================================="
          echo "Status: Running ‚úÖ"
          echo "URL: http://localhost:5000"
          echo ""
          echo "Available Endpoints:"
          echo "  GET  /           - Home page"
          echo "  GET  /items      - Get all items"
          echo "  POST /items      - Create item"
          echo "  GET  /items/<id> - Get item by ID"
          echo "  PUT  /items/<id> - Update item"
          echo "  DELETE /items/<id> - Delete item"
          echo "==================================="
          
      - name: üß™ Test API Endpoints
        if: success()
        run: |
          echo "Testing API endpoints..."
          
          # Test home endpoint
          echo "Testing GET /..."
          curl -s http://localhost:5000/ | jq '.'
          
          # Test creating an item
          echo "Testing POST /items..."
          curl -s -X POST http://localhost:5000/items \
            -H "Content-Type: application/json" \
            -d '{"name": "GitHub Actions Test", "description": "Created by CI/CD"}' | jq '.'
          
          # Test getting all items
          echo "Testing GET /items..."
          curl -s http://localhost:5000/items | jq '.'
          
          echo "‚úÖ All API endpoints tested successfully!"
          
      - name: ‚úÖ Deployment Summary
        if: success()
        run: |
          echo "==================================="
          echo "üéâ Deployment Successful!"
          echo "==================================="
          echo "Flask application deployed and tested"
          echo "All tests passed ‚úÖ"
          echo "Server is production ready üöÄ"
          echo "==================================="